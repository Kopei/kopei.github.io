---
title: enterprise-IoT-solution-desgin-for-healthcare-under-china-digital-environment
tags:
---

## 前言
物联网（IoT）的大规模应用对企业提出了独特的挑战，这些挑战主要在安全、隐私、合规性，以及成本方面。与传统的网络技术不同，物联网涉及到网络和物理世界融合。我们要使用网络连接设备知道真实物理世界设备发生了什么，又需要确保设备的安全配置、设备之间和云之间的安全连接，以及在云端进行处理和存储时的数据安全。然而，与此相对抗的是计算能力受限的设备、部署的地理分布以及大量设备的管理。本文将参考现有云原生物联网解决方案和医疗行业具体情况，结合中国本土的数字生态环境，尝试提出既符合行业需求又满足合规需要的医疗行业物联网设计方案。

## 基础架构
### Provision
安全的设备开通意味着为每个设备提供一个唯一的身份密钥，该密钥可以由物联网基础架构在设备运行时与设备通信。生成的密钥与用户选择的设备ID一起形成一个在设备与IoT Hub之间的所有通信中使用的令牌的基础。
设备ID可以在制造过程中与设备关联（即在硬件信任模块中烧录），也可以使用现有的固定身份作为代理（例如CPU序列号）。由于在设备中更改此识别信息并不简单，因此在底层设备硬件发生变化但逻辑设备保持不变的情况下引入逻辑设备ID非常重要。在某些情况下，设备身份的关联可以在设备部署时进行（例如，经过身份验证的现场工程师在与解决方案后端通信的同时物理配置新设备）。IoT Hub身份注册表提供了设备身份和解决方案的安全密钥的安全存储。设备身份的个体或组可以添加到允许列表或阻止列表，从而实现对设备访问的完全控制。云中的IoT Hub访问控制策略使得可以激活和禁用任何设备身份，提供在需要时将设备与物联网部署解除关联的方法。这种设备的关联和解关联基于每个设备的身份。

其他设备安全功能包括：
- 设备不接受未经请求的网络连接。它们以仅出站的方式建立所有连接和路由。要使设备从后端接收命令，设备必须启动连接以检查是否有任何待处理的命令。一旦设备与IoT Hub之间建立了安全连接，从云到设备和从设备到云的消息可以透明地发送。
- 设备只连接或建立与其配对的已知服务的路由，例如IoT Hub。
- 系统级的授权和身份验证使用每个设备的身份，使得访问凭证和权限可以迅速被撤销。

### 连接安全
使用业界成熟的协议进行安全连接 - HTTPS、AMQP和MQTT。
IoT Hub通过对消息的响应提供的确认系统，确保了云与设备之间消息的持久性。通过在IoT Hub中缓存消息，遥测数据可保留七天，而命令则可保留两天，从而实现了对消息的额外持久性。这种方法使得由于电源或连接性问题而偶尔连接的设备可以接收这些命令。IoT Hub为每个设备维护一个设备专用队列。可扩展性要求能够与各种设备安全互操作。IoT Hub支持与启用IP和未启用IP的设备进行安全连接（使用IoT Edge设备作为网关）。
其他连接安全功能包括：
- 设备与IoT Hub之间，或网关与IoT Hub之间的通信路径使用行业标准的传输层安全性（TLS）进行保护，使用X.509协议对IoT Hub进行身份验证。
- 为了保护设备免受未经请求的入站连接，IoT Hub不会打开任何连接到设备。设备启动所有连接。
- IoT Hub可靠地存储设备的消息，并等待设备连接。这些命令将被存储两天，使得由于电源或连接性问题而偶尔连接的设备可以接收这些命令。IoT Hub为每个设备维护一个设备专用队列。

### 安全计算和存储
通过使用身份ID进行用户身份验证和授权，IoT Hub可以为云中的数据提供基于策略的授权模型，实现易于审核和审查的访问管理。一旦数据进入云端，它可以在任何用户定义的工作流中进行处理和存储。根据使用的存储服务，使用Entra ID控制对数据的每个部分的访问。
物联网基础架构使用的所有密钥都存储在云中的安全存储中，具有重新配置密钥的能力。数据可以存储在Cosmos DB或SQL数据库中，从而定义所需的安全级别。此外，提供监视和审计所有对数据的访问的方式，以通知您任何入侵或未经授权的访问。

### 网络安全
默认情况下，IoT Hub的主机名映射到一个具有公共可路由IP地址的公共端点，通过互联网进行访问。这使得不同的客户可以共享这个IoT Hub公共端点，并确保通过广域网络和本地网络连接的物联网设备可以访问您的中心。然而，在某些情况下，您可能希望限制对资源的访问。IoT解决方案支持IP过滤和虚拟网络，以在需要时帮助保护访问。
有关安全网络访问的详细信息，请参阅以下资源：
- 使用 IP 过滤器。
- 虚拟网络支持：IoT Hub 支持使用 Private Link 和托管身份的虚拟网络。

### 受限设备的支持
不同物联网设备的能力各不相同。一些设备可能是运行常见桌面操作系统的计算机，而一些设备可能运行非常轻量级的操作系统。之前描述的安全最佳实践可能在不同程度上适用于这些设备。如果制造商提供了安全和部署最佳实践，应当遵循这些实践。
一些传统和受限制的设备可能并非专为物联网部署而设计。这些设备可能缺乏加密数据、连接到互联网或提供高级审计的能力。在这些情况下，一台现代且安全的现场网关可以聚合来自传统设备的数据，并提供连接这些设备到互联网所需的安全性。现场网关可以提供安全的身份验证、加密会话的协商、从云接收命令等许多安全功能。

## IoT设备管理
IoT设备管理涵盖了从制造商到设备退役的整个生命周期。包括：
- 回顾设备管理概念。
- 检查设备管理模式。
- 检查使用设备孪生`device twin`和`direct method`直接方法的设备配置选项。

### 设备管理的概念
设备的种类从受限传感器和单一用途的微控制器，到负责为一组设备路由通信的强大网关。此外，跨不同行业，物联网运营商的使用案例和需求差异显著。尽管存在这种差异，设计IoT的方案进行设备管理需要能提供满足各种设备和最终用户需求的能力、模式和代码库。

#### 设备的生命周期
一般设备的生命周期会经历5个阶段：计划-> 创建-> 配置 -> 监控 -> 退役
在这五个阶段中，有几个设备运营操作需求需要得到满足，以提供完整的解决方案：
1. **规划（Plan）：** 使运营人员能够创建一个设备元数据方案，使他们能够轻松准确地查询并为批量管理操作选择一组设备。您可以使用设备双将此设备元数据以标签和属性的形式存储。
2. **配置（Provision）：** 安全地为IoT Hub配置新设备，并使运营人员立即发现设备的功能。使用IoT Hub身份注册表创建灵活的设备身份和凭据，并通过使用作业进行批量执行此操作。要求设备通过设备双中的设备属性报告其功能和状态条件。
3. **配置（Configure）：** 在保持健康和安全性的同时促进对设备的批量配置更改和固件更新。通过使用期望的属性或使用直接方法和广播作业进行批量执行这些设备管理操作。
4. **监视（Monitor）：** 监视整体设备集合的健康状况、正在进行的操作的状态，并提醒运营人员可能需要关注的问题。使用设备双允许设备报告实时操作条件和更新操作的状态。通过使用设备双查询构建强大的仪表板报告，呈现最紧急的问题。
5. **退役（Retire）：** 在故障、升级周期或服务寿命结束后替换或停用设备。使用设备双在物理设备被替换时维护设备信息，或在退役时进行存档。使用IoT Hub身份注册表安全地撤销设备身份和凭据。

#### 设备管理的原则
每个企业级的IoT解决方案必须解决4个大的问题，或者说是4个原则必须遵循：
1. **规模和自动化：** 物联网解决方案需要简单的工具，能够自动执行例行任务，并使相对较小的运营人员团队能够管理数百万个设备。运营人员期望能够远程批量处理设备操作，并且只在出现需要他们直接关注的问题时接收警报。
2. **开放性和兼容性：** 设备生态系统异常多样化。管理工具必须经过定制，以适应多种设备类别、平台和协议。运营人员必须能够支持各种类型的设备，从最受限制的嵌入式单处理芯片到功能强大、完全功能的计算机。
3. **环境感知：** 物联网环境是动态且不断变化的。服务可靠性至关重要。设备管理操作必须考虑以下因素，以确保维护停机不会影响关键业务操作或创建危险情况：
    - SLA维护窗口
    - 网络和电源状态
    - 使用条件
    - 设备地理位置

4. **服务多个角色：** 对物联网运营角色的独特工作流程和流程的支持至关重要。运营人员必须与内部IT部门的给定约束和业务管理角色协同工作。他们还必须找到可持续的方式将实时设备操作信息呈现给监管人员和其他业务管理角色。

#### 设备管理的范式和交互方式
**交互方式**：
Azure有两种交互方式使后端的应用对设备进行管理操作，分别是`direct method`和`device twin`.
您可以使用云中的后端应用通过直接方法`direct method`从IoT Hub启动设备管理操作（如重新启动、恢复出厂设置和固件更新）。设备负责：
- 处理从IoT Hub发送的方法请求。
- 在设备上启动相应的特定于设备的操作。
- 通过报告的属性向IoT Hub提供状态更新。

您还可以使用云中的后端应用运行`device twin`查询，以设置设备期望属性或报告设备管理操作的进度。设备负责：
- 处理属性更改事件，并更新与设备孪生望属性对应的本地变量。
- 在成功实施更新的期望属性之后，向IoT Hub通信设备孪生报告的属性设置。

**范式**：
- Reboot设备管理模式：后端应用通过直接方法通知设备它已启动重新启动。设备使用报告的属性来更新设备的重新启动状态。
![reboot](/images/2024-02/device-management-rebot-pattern.png)
- Factory reset设备管理模式：后端应用通过直接方法通知设备它已启动恢复出厂设置。设备使用报告的属性来更新设备的恢复出厂设置状态。
![reset](/images/2024-02/device-management-factory-reset-pattern.png)
- Configuration设备管理模式：后端应用使用期望的属性来配置运行在设备上的软件。设备使用报告的属性来更新设备的配置状态。
![configure](/images/2024-02/device-management-configuration-pattern.png)
- Firmware update设备管理模式：后端应用使用自动设备管理配置来选择接收更新的设备，告诉设备在哪里找到更新，并监视更新过程。设备启动一个多步骤的过程，下载、验证和应用固件映像，然后在重新连接到IoT Hub服务之前重新启动设备。在整个多步骤过程中，设备使用报告的属性来更新设备的进度和状态。
![fireware](/images/2024-02/firm-update.png)
- 报告进度和状态：解决方案后端运行设备孪生，跨一组设备报告设备上运行的操作的状态和进度。
![report](/images/2024-02/device-management-reporting-progress-status-pattern.png)

#### 设备孪生device twin
在设备管理解决方案中，从后端服务配置设备是其中的核心组件。
为了在设备和IoT Hub之间同步状态信息，您使用设备孪生`device twin`。期望属性由后端应用设置并由设备读取。报告的属性由设备设置并由后端应用读取。设备孪生还包括由后端应用设置但从不发送到设备的标签。您使用标签`tags`提供描述性信息，例如位置，或者帮助组织/区分您的设备。
![device twin](/images/2024-02/device-management-using-device-twin-properties.png)

##### **后端管理device twin**
解决方案后端通过HTTPS使用以下原子操作对设备孪生进行操作：
1. **按ID检索设备孪生：** 该操作返回设备孪生文档，包括标签以及期望和报告的系统属性。
2. **部分更新设备孪生：** 该操作使解决方案后端能够部分更新设备孪生中的标签或期望属性。部分更新表示为一个JSON文档，用于添加或更新任何属性。设置为null的属性将被移除。以下是一个示例，创建一个新的期望属性，其值为 {"newProperty": "newValue"}，用"otherNewValue"覆盖了现有属性existingProperty的值，并移除了otherOldProperty。对现有期望属性或标签不进行其他更改：
```json
{
  "newProperty": "newValue",
  "existingProperty": "otherNewValue",
  "otherOldProperty": null
}
```
3. **替换期望属性：** 该操作使解决方案后端能够完全覆盖所有现有的期望属性，并用一个新的JSON文档替代属性/期望。
4. **替换标签：** 该操作使解决方案后端能够完全覆盖所有现有的标签，并用一个新的JSON文档替代标签。
5. **接收孪生通知：** 该操作允许解决方案后端在孪生被修改时收到通知。要实现这一点，您的物联网解决方案需要创建一个路由，并将数据源设置为twinChangeEvents。默认情况下，不存在这样的路由，因此不会发送孪生通知。如果更改率过高，或出现其他原因，例如内部故障，IoT Hub可能只发送包含所有更改的通知。因此，如果您的应用程序需要可靠地审核和记录所有中间状态，应使用设备到云的消息。孪生通知消息包括属性和主体。

##### **device twin管理设备**
设备应用程序通过以下原子操作对设备孪生进行操作：
- 检索设备孪生： 该操作返回当前连接设备的设备孪生文档（包括期望和报告的系统属性）。
- 部分更新报告的属性： 该操作允许部分更新当前连接设备的报告属性。此操作使用与解决方案后端对期望属性进行部分更新时相同的JSON更新格式。
- 观察期望属性： 当前连接的设备可以选择在期望属性发生更新时收到通知。设备接收由解决方案后端执行的相同形式的更新（部分或完全替换）。
所有上述操作都需要具有DeviceConnect权限。

##### 并发控制
IoT的事务推荐使用乐观并发。需要标签、期望和报告的属性都支持乐观并发。标签具有一个ETag，根据RFC7232，表示标签的JSON表示。您可以在解决方案后端的条件更新操作中使用ETags以确保一致性。设备孪生的期望和报告的属性没有ETags，但有一个保证是递增的$version值。与ETag类似，版本可以由更新方使用以强制执行更新的一致性。例如，对于报告的属性的设备应用程序或期望属性的解决方案后端。当观察代理（例如观察期望属性的设备应用程序）必须协调检索操作的结果和更新通知之间的竞争时，版本也是有用的。

##### 设备网络重连
IoT Hub不保留断开连接设备的期望属性更新通知。由此，即连接的设备必须检索完整的期望属性文档，同时订阅更新通知。考虑到更新通知和完整检索之间可能存在竞争的可能性，必须确保以下流程：
1. 设备应用连接到IoT Hub。
2. 设备应用订阅期望属性更新通知。
3. 设备应用检索完整的期望属性文档。
设备应用可以忽略所有具有$version小于或等于完整检索文档版本的通知。这种方法是可行的，因为IoT Hub保证版本始终递增。

#### 直接方式direct method
直接方法`direct method`表示与设备进行的请求-回复交互，类似于HTTP调用，即它们立即成功或失败（在用户指定的超时后）。这种方法对于根据设备是否能够响应而采取即时行动的情况非常有用。
直接方法具有以下特点：
1. 每个直接方法针对单个设备。您可以使用IoT Hub作业在多个设备上调用直接方法，并对断开连接的设备安排方法调用的计划。
2. 在IoT Hub上具有服务连接权限的任何人都可以在设备上调用方法。
3. 直接方法遵循请求-响应模式，适用于需要立即确认结果的通信。例如，对设备进行交互式控制，如打开风扇。

##### 直接方式的生命周期
直接方法是在设备上实现的，可能需要零个或多个输入在方法负载中正确实例化。通过服务面向的`URI（{iot hub}/twins/{device id}/methods/）`调用直接方法。设备通过特定于设备的MQTT主题`（$iothub/methods/POST/{method name}/）`或通过AMQP链接`（IoThub-methodname和IoThub-status应用程序属性）`接收直接方法。直接方法是同步的，只有在超时期限后（默认为30秒，可在5-300秒的范围内设置）才会成功或失败。直接方法在交互式场景中非常有用，其中您只希望设备在线并接收命令时才执行操作。例如，从手机打开灯。在这些情景中，您希望立即看到成功或失败的结果，以便云服务能够尽快对结果采取行动。设备可能会返回某些消息体作为方法的结果，但并不要求方法这样做。对于方法调用，没有关于排序或任何并发语义的保证。
直接方法在云端是仅支持HTTPS的，而在设备端则是支持MQTT或AMQP的。

#### Direct method和Device twin选择
以下是信息格式化为表格，并进行中文翻译：

| 特性                     | 直接方法                                     | 孪生的期望属性                                      | 云到设备的消息                                    |
|------------------------|----------------------------------------------|-----------------------------------------------------|---------------------------------------------------|
| **场景**                | 需要即时确认的命令，例如打开风扇               | 用于将设备置于特定期望状态的长时间运行命令，例如将遥测发送间隔设置为30分钟 | 向设备应用程序发送的单向通知                           |
| **数据流**             | 双向                                           | 单向                                               | 单向                                            |
| **持久性**             | 断开连接的设备不会被联系                           | 设备孪生中保留属性值                                  | IoT Hub最多保留48小时的消息                        |
| **目标**               | 使用deviceId的单个设备，或使用作业的多个设备           | 使用deviceId的单个设备，或使用作业的多个设备           | 使用deviceId的单个设备                             |
| **大小**               | 最大负载大小：128 KB                           | 最大大小：32 KB                                     | 最多64 KB                                        |
| **频率**               | 高频                                           | 中频                                               | 低频                                            |
| **协议**               | 可使用MQTT或AMQP                               | 可使用MQTT或AMQP                               | 在所有协议上都可用；使用HTTPS时设备必须轮询              |

## 人员与角色
一个完善的物联网架构需要物联网设备和基础设施的制造、开发和部署的不同角色的积极参与。以下是这些参与者的高层描述。
- 物联网硬件制造商/集成商： 通常，这些参与者是正在部署的物联网硬件的制造商、组装来自不同制造商的硬件的集成商，或为由其他供应商制造或集成的物联网部署提供硬件的供应商。
- 物联网解决方案开发者： 物联网解决方案的开发通常由解决方案开发者完成。这个开发者可能是内部团队的一部分，也可能是专门从事此活动的系统集成商（SI）。物联网解决方案开发者可以从头开始开发物联网解决方案的各个组件，集成各种现成的或开源的组件，或采用一些解决方案加速器并进行少量的调整。
- 物联网解决方案部署者： 在物联网解决方案开发完成后，需要在实地进行部署。这个过程涉及硬件的部署、设备的互连以及在硬件设备或云中部署解决方案。
- 物联网解决方案运营商： 在物联网解决方案部署后，需要进行长期的运营、监控、升级和维护。这些任务可以由内部团队执行，该团队包括信息技术专业人员、硬件运营和维护团队，以及监测整体物联网基础设施正确行为的领域专业人员。

### 物联网硬件制造商/集成商
这角色将硬件范围限制到最低要求： 硬件设计应包括硬件操作所需的最小功能，不多余。例如，只在设备操作所必需时包含USB端口。这些额外的功能会打开设备，使其容易受到不必要的攻击向量，应予以避免。
制作防篡改硬件： 构建能够检测物理篡改的机制，例如检测设备盖子打开或移除设备的某个部分。这些篡改信号可以作为上传到云的数据流的一部分，从而通知操作员发生了这些事件。
基于安全硬件构建： 如果成本允许，构建安全功能，如安全和加密存储，或基于可信平台模块（TPM）的引导功能。这些功能使设备更安全，并有助于保护整体的物联网基础设施。
确保升级的安全性： 设备寿命内不可避免地需要进行固件升级。构建具有升级的安全路径和对固件版本的加密保证的设备将使设备在升级期间和之后保持安全。

### 物联网解决方案开发者
此角色需要：
- **遵循安全软件开发方法论：** 开发安全软件需要从项目的构思一直到实施、测试和部署都考虑到安全性。选择平台、语言和工具时都要遵循这种方法论。Microsoft 安全开发生命周期提供了逐步构建安全软件的方法。
- **谨慎选择开源软件：** 开源软件为快速开发解决方案提供了机会。在选择开源软件时，考虑每个开源组件的社区活跃水平。一个活跃的社区确保软件得到支持，并且问题会被发现和解决。相反，一个鲜为人知且不活跃的开源软件项目可能不受支持，并且问题可能不太可能被发现。
- **谨慎集成：** 许多软件安全缺陷存在于库和API的边界处。可能通过API层仍然可用的功能可能并不是当前部署所需的。为了确保整体安全性，请确保检查正在集成的所有组件的所有接口以寻找安全缺陷。

### **物联网解决方案部署者**
以下是物联网解决方案部署者的最佳实践：
- **安全部署硬件：** 物联网部署可能需要在不安全的位置部署硬件，比如在公共场所或无人看管的地方。在这种情况下，确保硬件部署在最大程度上是防篡改的。如果硬件上有USB或其他端口，请确保它们被安全地覆盖。许多攻击向量可以利用这些端口作为入口点。
- **保护认证密钥：** 在部署过程中，每个设备都需要由云服务生成的设备ID和相关的认证密钥。即使在部署后，也要确保将这些密钥物理上保存安全。任何被 compromise 的密钥都可以被恶意设备用来伪装成现有设备。

### **物联网解决方案运营商**
以下是物联网解决方案运营商的最佳实践：
- **保持系统更新：** 确保设备操作系统和所有设备驱动程序升级到最新版本。如果在Windows 10（IoT或其他版本）中启用了自动更新，Microsoft将保持其最新，为物联网设备提供安全的操作系统。将其他操作系统（如Linux）保持最新，有助于确保它们也受到对恶意攻击的保护。
- **防范恶意活动：** 如果操作系统允许，安装每个设备操作系统上的最新防病毒和防恶意软件功能。这种做法有助于缓解大多数外部威胁。通过采取适当的步骤，可以保护大多数现代操作系统免受威胁。
- **频繁审计：** 对与安全问题相关的IoT基础设施进行审计是在应对安全事件时的关键步骤。大多数操作系统提供内置的事件日志记录，应该经常查看，以确保没有发生安全漏洞。审计信息可以作为独立的遥测流发送到云服务，在那里可以进行分析。
- **物理保护物联网基础设施：** 针对物理访问设备发起的对物联网基础设施的最严重的安全攻击，采用物理接入的防范措施是重要的。一个重要的安全实践是保护免受对USB端口和其他物理访问的恶意使用。发现可能发生的入侵的关键是记录物理访问，如USB端口的使用。同样，Windows 10（IoT和其他版本）启用了这些事件的详细日志记录。
- **保护云凭证：** 用于配置和操作物联网部署的云身份验证凭据可能是获取访问并危害物联网系统的最简单途径。通过经常更改密码来保护这些凭据，并避免在公共机器上使用这些凭据。


## Security Design

### Security Principles
#### 通则
- 保持更新。使用最新版本的平台、编程语言、协议和框架。
- 确保认证密钥的安全性。在部署后，保管好设备ID及其认证密钥，防止恶意设备冒充已注册的设备。
- 尽可能使用设备SDK。设备SDK实现了安全功能，如加密、认证等，以帮助开发强大且安全的设备应用程序。

#### 访问控制
- 控制物联网中心的访问控制。了解并定义在你的物联网中心解决方案中，每个组件将根据其功能拥有的访问类型。允许的权限包括Registry Read、RegistryReadWrite、ServiceConnect和DeviceConnect。你的物联网中心中的默认共享访问策略也可以根据其角色定义每个组件的权限。
- 定义后端服务的访问控制。你的物联网中心解决方案摄取的数据可以被其他后端服务消费，如数据库，计算和存储。确保理解并允许适当的访问权限。

#### 数据保护
- 确保设备身份验证的安全性。通过使用唯一身份密钥、安全令牌或每个设备的设备上X.509证书，确保设备与IoT中心之间的通信安全。根据选择的协议（MQTT、AMQP或HTTPS），使用适当的方法使用安全令牌。
- 确保设备通信的安全性。IoT中心使用传输层安全性（TLS）标准来保护与设备的连接，使用TLS 1.2以确保最大的安全性。
- 确保服务通信的安全性。IoT中心提供连接到后端服务的端点，只使用TLS协议，没有端点暴露在未加密的通道上。一旦数据到达这些后端服务进行存储或分析，请确保对该服务使用适当的安全和加密方法，并在后端保护敏感信息。

#### 网络安全
- 保护对设备的访问。将设备中的硬件端口保持到最低程度，以避免未经授权的访问。此外，构建机制以防止或检测对设备的物理篡改。
- 构建安全的硬件。集成安全功能，如加密存储或可信平台模块（TPM），以使设备和基础设施更加安全。保持设备操作系统和驱动程序升级到最新版本，如果空间允许，安装防病毒和防恶意软件功能。详细了解物联网安全架构，以了解如何帮助缓解多种安全威胁。

#### 监控
- 监控对设备的未经授权访问。利用设备操作系统的日志功能，监控任何安全漏洞或对设备或其端口的物理篡改。
- 从云端监控你的物联网解决方案。使用Azure Monitor中的指标监控你的物联网中心解决方案的整体健康状况。
- 设置诊断。通过在你的解决方案中记录事件，紧密关注运营情况，然后将诊断日志发送到Azure Monitor以获得性能可见性。详细了解在你的物联网中心中监视和诊断问题。

### 威胁模型
#### **威胁建模** 
威胁建模的目标是了解攻击者可能如何攻击系统，然后确保采取适当的缓解措施。
**威胁建模时要考虑的内容：**
应该将整个解决方案视为一个整体，并专注于以下几个方面：
1. 安全和隐私特性。
2. 失败可能导致安全问题的特性。
3. 接触信任边界的特性。
**谁执行威胁建模：**
威胁建模是一个类似于其他流程的过程。将威胁模型文档视为解决方案的任何其他组件，并作为团队对其进行验证是一个好主意。许多开发团队在捕捉有益于客户的系统的功能要求方面做得非常出色。然而，识别某人可能滥用系统的不明显方式更具挑战性。威胁建模可以帮助开发团队了解攻击者可能会做什么以及为什么。
**如何执行威胁建模：**
威胁建模过程包括四个步骤，这些步骤是：
1. **建模应用程序：** 创建应用程序的模型。
2. **列举威胁：** 识别潜在的威胁，即可能导致系统受到攻击的方式。
3. **缓解威胁：** 制定和实施减轻威胁的方法和策略。
4. **验证缓解措施：** 确保采取的缓解措施有效并按预期运行。

#### 威胁模型在架构方面的考虑
**物联网中的安全性**
连接的专用设备具有大量潜在的交互表面和交互模式，所有这些都必须考虑在内，以提供保护数字访问这些设备的框架。这里使用术语“数字访问”来区别于通过直接设备交互进行的任何操作，其中访问安全性通过物理访问控制提供。例如，将设备放置在带有门锁的房间中。虽然通过软件和硬件无法拒绝物理访问，但可以采取措施防止物理访问导致系统干扰。
为了优化安全最佳实践，建议将典型的物联网架构作为威胁建模的一部分划分为多个组件/区域。这些区域包括：
1. **设备**
2. **物联网边缘网关（用作现场网关的物联网边缘设备）**
3. **云网关（物联网中心）**
4. **服务**
每个区域由一个信任边界分隔，代表数据/信息从一个源传递到另一个源的过渡。在这个过渡过程中，数据/信息可能会受到欺骗、篡改、否认、信息泄露、拒绝服务和提权（STRIDE）的影响。
我们可以使用Azure IoT参考架构来演示如何思考物联网的威胁建模以及如何解决识别出的威胁。这种方法确定了四个主要关注点：
1. **设备和数据源。**
2. **数据传输。**
3. **设备和事件处理。**
4. **展示。**

#### **常见的安全威胁和缓解方法**
对于IoT解决方案，威胁通常主要针对物理设备或简化的威胁模型图中识别的信任边界之一。
考虑以下STRIDE定义：
1. **伪造（Spoofing - S）：** 伪造攻击发生在攻击者假装成他们不是的情况下。伪造攻击可能在本地发生。例如，攻击者可能从设备中提取密码密钥材料（无论是在软件层面还是硬件层面），然后使用从该设备中提取的密钥材料，通过不同物理设备的身份访问系统。
2. **篡改（Tampering - T）：** 篡改攻击发生在攻击者修改传输中的数据时（对于物联网可能包括对物理设备进行破坏）。例如，攻击者可能破坏物理设备以获取密码密钥材料，然后截取和抑制设备上通信路径上的数据，并最终使用提取的密钥材料替换数据，该数据使用被窃取的密钥材料进行身份验证。
3. **否认（Repudiation - R）：** 否认发生在某人执行一个动作然后声称他们实际上没有执行它时。否认通常与能够正确跟踪和记录用户操作的能力有关，对于Azure IoT，这种威胁由Azure IoT Hub服务缓解。否认不适用于对物理设备的攻击。
4. **信息泄露（Information Disclosure - I）：** 信息泄露威胁很直接 - 攻击者能否查看他们不应查看的数据？例如，如果您正在从一台计算机传输数据到另一台计算机，而攻击者可以在传输的数据上嗅探数据，则您的组件可能受到信息泄露威胁。
5. **拒绝服务（Denial of Service - D）：** 拒绝服务威胁发生在攻击者能够降级或拒绝向用户提供服务时。对于物联网，此降级包括使设备无法正常工作或通信。例如，故意切断电力或网络连接的监控摄像机将无法报告数据。
6. **权限提升（Elevation of Privilege - E）：** 权限提升威胁发生在攻击者能够获取他们通常不具备的权限时。对于物联网，此威胁可能是强制设备执行与预期功能不同的操作。例如，一个被编程为打开一半的阀门可能会被欺骗打开全部。

#### 物理设备的常见威胁
| 组件                      | 威胁 | 缓解方法                                            | 风险                                                 | 实施                                               |
|--------------------------|------|-----------------------------------------------------|--------------------------------------------------------|------------------------------------------------------|
| 设备                     | S    | 为设备分配身份并对设备进行身份验证。                  | 用其他设备替换设备或设备的一部分。您如何知道您正在与正确的设备交流？ | 对设备进行身份验证，使用传输层安全性（TLS）或IPSec。基础设施应支持在那些不能处理完全非对称加密的设备上使用预共享密钥（PSK）。使用Microsoft Entra ID或OAuth。 |
| 设备                     | TID  | 对设备应用防篡改机制，例如，通过使从设备中提取密钥和其他密码材料变得困难或不可能。 | 风险在于有人篡改设备（物理干扰）。您如何确保设备没有被篡改。 | 最有效的缓解措施是信任平台模块（TPM）功能，允许将密钥存储在特殊的芯片电路中，从中无法读取密钥，但只能用于使用密钥但永不披露密钥的加密操作。对设备进行内存加密。设备的密钥管理。对代码进行签名。 |
| 设备                     | E    | 对设备进行访问控制。授权方案。                         | 如果设备允许根据外部源的命令执行个别操作，甚至允许来自受损传感器的命令，攻击者可以执行否则无法访问的操作。 | 为设备制定授权方案。                   |
| IoT边缘网关（现场网关）   | S    | 对现场网关进行身份验证，连接到云网关（例如基于证书，PSK或声明）。 | 如果有人可以欺骗现场网关，那么它可以将自己呈现为任何设备。 | TLS RSA/PSK，IPSec，RFC 4279。与一般设备相同的所有密钥存储和证明关注 - 最好的情况是使用TPM。IPSec的6LowPAN扩展以支持无线传感器网络（WSN）。 |
| IoT边缘网关（现场网关）   | TID  | 保护现场网关免受篡改（TPM？）                       | 通过欺骗云网关以为它正在与现场网关交流的欺骗攻击可能导致信息泄露和数据篡改。 | 内存加密，TPM，身份验证。                  |
| IoT边缘网关（现场网关）   | E    | 现场网关的访问控制机制。                             |                                                        |                                                      |                                             |
以下是对物理设备的一些威胁的例子：
- 伪造：攻击者可能会在设备的软件或硬件层面提取加密密钥材料，然后使用不同的物理或虚拟设备在密钥材料被提取的设备的身份下访问系统。
- 拒绝服务：通过干扰无线电频率或剪断电线，设备可能无法运行或通信。例如，有意切断电源或网络连接的监视摄像头将无法报告任何数据。
- 篡改：攻击者可能部分或完全替换设备上运行的软件，如果密钥材料或保存密钥材料的加密设施对非法程序可用，则替换的软件可能使用设备的真实身份。
- 篡改：显示空走廊的可见光谱图片的监视摄像头可能瞄准的是这样一个走廊的照片。烟雾或火灾传感器可能报告有人在其下点燃打火机。在任何一种情况下，设备在技术上可能对系统完全可信，但它报告的是被操纵的信息。
- 篡改：攻击者可能使用提取的密钥材料在通信路径上截取并抑制设备的数据，并用具有被窃密钥材料的假数据替换它。
- 篡改：攻击者可能部分或完全替换设备上运行的软件，如果密钥材料或保存密钥材料的加密设施对非法程序可用，则替换的软件可能使用设备的真实身份。
- 信息泄露：如果设备运行受操纵的软件，该软件可能潜在地向未经授权的方提供数据。
- 信息泄露：攻击者可能使用提取的密钥材料将自己注入到设备与控制器、现场网关或云网关之间的通信路径中，以窃取信息。
- 拒绝服务：设备可以被关闭或变成无法通信的状态（这在许多工业机器中是有意的）。
- 篡改：设备可以被重新配置为在控制系统不知道的状态中运行（超出已知校准参数），从而提供可能被错误解释的数据。
- 权限提升：可以强制执行具有特定功能的设备执行其他操作。例如，编程为打开一半的阀门可能被欺骗为完全打开。

#### 常见对通信的威胁例子
| 组件                   | 威胁   | 缓解措施                                    | 风险                                                              | 实施方式                                                                                                              |
|------------------------|--------|---------------------------------------------|-------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------|
| 设备到物联网中心        | TID    | 使用(D)TLS (PSK/RSA)加密流量。               | 窃听或干扰设备与网关之间的通信。                               | 在协议级别上提供安全性。对于自定义协议，需要找出如何保护它们。在大多数情况下，通信是从设备到物联网中心进行的（设备发起连接）。                        |
| 设备到设备              | TID    | 使用(D)TLS (PSK/RSA)加密流量。               | 读取设备之间传输的数据。篡改数据。使设备过载以创建新连接。         | 在协议级别上提供安全性（MQTT/AMQP/HTTP/CoAP）。对于自定义协议，需要找出如何保护它们。对于 DoS 威胁的缓解是通过云或现场网关将设备进行对等连接，并使它们仅作为网络的客户端。在由网关进行代理后，对等体之间可能会产生直接连接。 |
| 外部实体到设备          | TID    | 外部实体与设备之间的强大配对。               | 窃听与设备的连接。干扰与设备的通信。                             | 安全地将外部实体与设备进行配对，使用 NFC/Bluetooth LE。控制设备的操作面板（物理方式）。                             |
| 物联网边缘网关到云网关 | TID    | 使用TLS (PSK/RSA)加密流量。                  | 窃听或干扰设备与网关之间的通信。                               | 在协议级别上提供安全性（MQTT/AMQP/HTTP/CoAP）。对于自定义协议，需要找出如何保护它们。                                |
| 设备到云网关            | TID    | 使用TLS (PSK/RSA)加密流量。                  | 窃听或干扰设备与网关之间的通信。                               | 在协议级别上提供安全性（MQTT/AMQP/HTTP/CoAP）。对于自定义协议，需要找出如何保护它们。                               |

具体例子如下
| 威胁                   | 描述                                                                                                                                                                                                                        |
|------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 服务拒绝攻击            | 受限设备在主动监听网络上入站连接或未经请求数据报时容易受到拒绝服务攻击。攻击者可以并行打开许多连接，不提供服务，慢慢提供服务，或者用未经请求的流量淹没设备，使其在网络上无法运行。                                                                                                            |
| 伪造，信息泄露           | 受限和专用设备通常依赖于一对所有安全设施，如密码或PIN保护。它们可能信任网络，当设备在相同网络上时，授予对信息的访问。如果共享密钥被披露，攻击者可以控制设备或观察从设备发出的数据。                                                                                                        |
| 伪造                   | 攻击者可能会拦截或部分覆盖广播并伪造发起者。                                                                                                                                                                             |
| 篡改                   | 攻击者可能会拦截或部分覆盖广播并发送虚假信息。                                                                                                                                                                         |
| 信息泄露                | 攻击者可能会窃听广播并在未经授权的情况下获取信息。                                                                                                                                                                      |
| 服务拒绝攻击            | 攻击者可能会干扰广播信号并拒绝信息传播。                                                                                                                                                                              |