<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="mysql">
    <meta name="description" content="Hexo Theme Redefine">
    <meta name="author" content="Kopei">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-redefine.png">
    
        
            <link rel="preconnect" href="https://evan.beee.top" crossorigin>
        
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://kopei.github.io/2017/11/14/database-mysql-2017-11-15-high-performance-mysql/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    <meta property="og:type" content="article">
    <meta property="og:title" content="高性能mysql笔记">
    <meta property="og:description" content="Hexo Theme Redefine">
    <meta property="og:url" content="https://kopei.github.io2017/11/14/database-mysql-2017-11-15-high-performance-mysql/">
    
    <meta property="og:site_name" content="Kopei&#39;s Home">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="高性能mysql笔记">
    <meta name="twitter:description" content="Hexo Theme Redefine">
    <meta name="twitter:image" content="/images/k-favicon.jpeg">
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="../../../../images/k-favicon.jpeg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="../../../../images/k-favicon.jpeg">
    <meta name="theme-color" content="#005080">
    <link rel="shortcut icon" href="../../../../../../../../images/k-favicon.jpeg">
    
    <title>
        
            高性能mysql笔记 -
        
        Kopei&#39;s Home
    </title>
    
<link rel="stylesheet" href="css/style.css">

    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/assets/fonts.css">
    
    
    
    <script id="hexo-configurations">
    let REDEFINE = window.REDEFINE || {};
    REDEFINE.hexo_config = {"hostname":"kopei.github.io","root":"/","language":"en","path":"search.xml"};
    REDEFINE.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#005080","avatar":"/images/kopei-icon.jpeg","favicon":"/images/k-favicon.jpeg","og_image":{"enable":false,"image_url":null},"article_img_align":"center","right_side_width":"200px","content_max_width":"1000px","nav_color":{"left":"#f78736","right":"#367df7","transparency":35},"hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title_color":{"light":"#fff","dark":"#d1d1b6"},"font_sizes":{"title":"2.8rem","subtitle":"1.5rem"},"line_height":1.2,"title":"八卦成列 森罗万象","subtitle":{"enable":false,"list":[]},"custom_font":{"enable":false,"font_family":null,"font_url":null}},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_block":{"copy":true,"style":"mac","custom_font":{"enable":false,"font_family":null,"font_url":null}},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"1.2.1","friend_links":{"columns":2},"home_article":{"date_format":"auto","category":{"enable":true,"limit":3},"tag":{"enable":true,"limit":3}},"plugins":{"aplayer":{"enable":false,"audio":[{"name":null,"artist":null,"url":null,"cover":null},{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}}};
    REDEFINE.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
    
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/fontawesome/regular.min.css">
    
    
    
    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="menu-wrapper">
    
    <div class="menu-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Kopei&#39;s Home
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="pc">
                <ul class="menu-list">
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="../../../../index.html"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="../../../../archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="menu-drawer">
        <ul class="drawer-menu-list">
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="../../../../index.html"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="../../../../archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">高性能mysql笔记</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="../../../../../../../../images/kopei-icon.jpeg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Kopei</span>
                            
                                <span class="author-label">article</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="pc">2017-11-15</span>
        <span class="mobile">2017-11-15 00</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="pc">2023-08-21 14:14</span>
            <span class="mobile">2023-08-21 14:14</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="../../../../categories/database/">database</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="../../../../tags/mysql/">mysql</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h3 id="sql执行大致流程"><a href="#sql执行大致流程" class="headerlink" title="sql执行大致流程"></a>sql执行大致流程</h3><ul>
<li>客户端发送一条查询给服务器。</li>
<li>服务器先检查查询缓存，如果命中了缓存，则立刻返回存储在缓存中的结果。否则进入下一阶段。</li>
<li>服务器端进行SQL解析、预处理，再由优化器生成对应的执行计划。</li>
<li>MySQL根据优化器生成的执行计划，再调用存储引擎的API来执行查询。</li>
<li>将结果返回给客户端。</li>
</ul>
<h3 id="mysql的架构"><a href="#mysql的架构" class="headerlink" title="mysql的架构"></a>mysql的架构</h3><ul>
<li>mysql采用存储和计算分离的架构, 是一个典型的单进程多线程模型数据库.</li>
<li>mysql可以开启线程池，处理客户端的请求。</li>
<li>select语句会在缓存中先查找，没有hit才会到解释器。</li>
<li>解释器创建内部数据结构并做优化，最后才到存储器API。优化决策时用户可以使用hint关键字来影响mysql的决策过程，也可能使用explain来看看mysql是怎么决策的。</li>
<li>优化器会查询存储引擎提供一些信息来帮助优化。<br><img src="https://s3.ap-southeast-1.amazonaws.com/kopei-public/screen_shot%202019-01-08%20at%2021.26.22.png" alt="https://s3.ap-southeast-1.amazonaws.com/kopei-public/screen_shot%202019-01-08%20at%2021.26.22.png"></li>
</ul>
<h3 id="启动一个mysql实例"><a href="#启动一个mysql实例" class="headerlink" title="启动一个mysql实例"></a>启动一个mysql实例</h3><p>一般命令行启动mysql需要指定<code>basedir</code>, <code>datadir</code>, <code>user</code>, <code>log-error</code>, <code>pid-file</code>, <code>socket</code>等参数, <code>basedir</code>下面放置项目二进制可执行文件和库文件,pid文件和socket等文件. <code>datadir</code>目录下放置server log文件, innodb相关文件, 数据文件如<code>.ibd</code>数据和索引文件, <code>.frm</code>对象结构文件等.</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mysql/libexec/mysqld --basedir=/usr/local/mysql --datadir=/usr/local/mysql/var --user=mysql --log-error=error.log \</span><br><span class="line">--pid-file=/usr/local/mysql/var/mysql.pid --socket=/tmp/mysql.sock --port=3306</span><br></pre></td></tr></table></figure></div>

<h3 id="mysql的并发控制"><a href="#mysql的并发控制" class="headerlink" title="mysql的并发控制"></a>mysql的并发控制</h3><ul>
<li>mysql在服务层和存储层都做了并发控制， 一般使用锁来控制并发。</li>
<li>存储引擎有自己的锁策略和颗粒度，但是服务层的策略高于存储层。比如alter table 使用应用层的表锁，忽略存储层锁机制。</li>
<li>行锁只有在存储层实现, 一般通过多版本并发控制MVCC, 提升并发性能。简单原理是一个事务看到的是某一时刻数据的备份。</li>
<li>可以显式地加锁：<ul>
<li><code>select ... lock in share mode;</code></li>
<li><code>select ... for update;</code></li>
</ul>
</li>
</ul>
<h3 id="MVCC-Multi-Version-concurrent-control"><a href="#MVCC-Multi-Version-concurrent-control" class="headerlink" title="MVCC(Multi-Version concurrent control)"></a>MVCC(Multi-Version concurrent control)</h3><ul>
<li>实现机制： 基于某个时间点的快照。非阻塞度，行锁写</li>
<li>InnoDB在每个行记录后面保存两个隐藏的列(时间上根据mysql版本不同，有更多的隐藏列, 5.7是3个字段）， 一个行的创建时间，一个是过期时间。时间都是系统版本号。</li>
<li>在repeartable read隔离等级下， mvcc的操作:<ul>
<li>select:<br>    只会查到当前事务版本号前面或等于当前版本号（事务修改过）的行。<br>    删除的行也会作比较。</li>
<li>insert:<br>    插入一条数据，加2个隐藏的列</li>
<li>delete:<br>    删除一行，在删除列加入当前系统版本</li>
<li>update:<br>    插入一条新的记录，把老的记录删除行更新系统版本。</li>
</ul>
</li>
</ul>
<h3 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h3><ul>
<li>它是被设计为处理大量短时事务。</li>
<li>使用next-key locking实现防止幻读。</li>
</ul>
<h3 id="事务只有在存储引擎实现"><a href="#事务只有在存储引擎实现" class="headerlink" title="事务只有在存储引擎实现"></a>事务只有在存储引擎实现</h3><ul>
<li>需要格外小心事务中混合了事务型和非事务型表</li>
</ul>
<h3 id="ACID是一个事务的标准特征"><a href="#ACID是一个事务的标准特征" class="headerlink" title="ACID是一个事务的标准特征"></a>ACID是一个事务的标准特征</h3><ul>
<li>mysql主要关心两个隔离等级，<code>Read committed</code>和<code>repeatable read</code>。 <code>read committed</code>也是<code>nonrepeatable read</code>.<br>repeatable read是mysql默认隔离等级，保证同一个事务多次读取同样记录结果一致。</li>
<li>InnoDB使用不同<code>locking strategy</code>来实现不同隔离等级.</li>
<li>在多个事务里可能出现死锁现象, innoDB处理的方式是将最少行级排它锁进行回滚。</li>
</ul>
<h3 id="隔离等级下的幻读和脏读"><a href="#隔离等级下的幻读和脏读" class="headerlink" title="隔离等级下的幻读和脏读"></a>隔离等级下的幻读和脏读</h3><p>假设有一张表: t_1(id primary key, name) 有三条数据.<br>幻读现象会在这种情况出现, A事务先执行:<br><code>select * from t_1 where id=4</code><br>然后B事务执行<br><code>insert into t_1 values (4, &#39;Hanny&#39;)</code><br><strong>如果此时隔离等级是<code>read committed</code></strong>,那么事务A再执行<code>select * from t_1 where id=4</code>就会读到这条数据, 出现所谓的<strong>幻读</strong>. 如果此时的隔离等级是<code>repeatable read</code>那么A事务再执行select将不会读到<code>id=4</code>的数据.<br>脏读现象出现在A事务读取了B事务未提交的更新, 如A事务<code>start transaction; insert into t_1 values (4, &#39;hanny&#39;)</code>, B事务<code>select * from t_1 where id=4</code>读到了数据, 就是脏读. 这种情况一般出现在隔离等级在<code>read uncommitted</code>的时候.</p>
<h3 id="和隔离等级密切相关的各种锁-V5-7"><a href="#和隔离等级密切相关的各种锁-V5-7" class="headerlink" title="和隔离等级密切相关的各种锁(V5.7)"></a>和隔离等级密切相关的各种锁(V5.7)</h3><ul>
<li><code>record lock</code>记录锁, <code>select ... lock in share mode/select ... for update</code>会加记录锁, 锁定的这行不能被另一个事务做<code>insert, update, delete</code>. 记录锁会锁定有索引的记录, 如果表没有定义索引, innodb会隐含创建<code>hidden clustered index</code>. 在<code>RR</code>隔离等级下, <code>select ... lock in share mode/select ... for update</code>加上where唯一索引作为唯一查询条件, 可以实现<code>RR</code>.</li>
<li></li>
</ul>
<h3 id="使用事务日志可以提高存储引擎修改表数据效率"><a href="#使用事务日志可以提高存储引擎修改表数据效率" class="headerlink" title="使用事务日志可以提高存储引擎修改表数据效率"></a>使用事务日志可以提高存储引擎修改表数据效率</h3><ul>
<li>做法类似redis, 仅仅持久化事务日志，在内存中更新数据，然后后台再慢慢写入磁盘。</li>
</ul>
<h3 id="Mysql提供两种事务性存储引擎InnoDB-NBD-cluster"><a href="#Mysql提供两种事务性存储引擎InnoDB-NBD-cluster" class="headerlink" title="Mysql提供两种事务性存储引擎InnoDB, NBD cluster"></a>Mysql提供两种事务性存储引擎InnoDB, NBD cluster</h3><ul>
<li>自动提交auto-commit： 默认开启，即便不是显式开启，每个查询还是会默认进行事务。</li>
</ul>
<h3 id="Mysql的复制方式"><a href="#Mysql的复制方式" class="headerlink" title="Mysql的复制方式"></a>Mysql的复制方式</h3><ul>
<li>主库记录二进制日志，备库将主库日志复制到中继日志（relay log)后，重放二进制日志。同一时间点主备数据可能不一致。</li>
</ul>
<h3 id="设计mysql备份方案"><a href="#设计mysql备份方案" class="headerlink" title="设计mysql备份方案"></a>设计mysql备份方案</h3><ul>
<li><p>逻辑备份恢复太慢，采用ExtraBackup快照备份是物理备份较好的选择。</p>
</li>
<li><p>保留多个备份集</p>
</li>
<li><p>定期恢复</p>
</li>
<li><p><strong>expire_logs_bin</strong> 设置足够长，保留二进制日志文件用于基于时间点的恢复。</p>
</li>
<li><p>监控和检查备份是否正常？监控恢复需要耗费多少资源和时间？</p>
</li>
<li><p>选择在线备份，可能是导致mysql服务中断</p>
</li>
<li><p>逻辑备份导出的文件要么是sql要么是类似csv的文本；物理备份就是直接复制原始文件。</p>
<ul>
<li>逻辑备份的优点：</li>
</ul>
<ol>
<li>逻辑备份可以消除底层存储引擎的影响<br>  2. 如果内存保存着正确数据但是磁盘坏了，不能复制一个正确的物理备份， 仍可能导出一个正常的逻辑备份。</li>
</ol>
<ul>
<li>逻辑备份的缺点：</li>
</ul>
<ol>
<li>需要消耗cpu，恢复时间较长，需要建index等。</li>
<li>ASCII形式的数据可能比原始数据大</li>
<li>恢复时可能由于bug或者浮点表示问题，无法保证还原一模一样的数据。</li>
</ol>
<ul>
<li>物理备份的优点：</li>
</ul>
<ol>
<li>恢复快速， 不需要执行任何sql或构建索引。</li>
</ol>
<ul>
<li>物理备份的缺点：</li>
</ul>
<ol>
<li>原始文件比逻辑备份大</li>
<li>可能不总是夸平台</li>
</ol>
</li>
<li><p>使用check tables或mysqlcheck 检查恢复操作。</p>
</li>
</ul>
<h3 id="推荐的备份方案"><a href="#推荐的备份方案" class="headerlink" title="推荐的备份方案"></a>推荐的备份方案</h3><ul>
<li>先一周使用一次使用物理备份，启动mysql实例，运行mysqlcheck, 然后在服务器负载低时周期性地mysqldump执行逻辑备份，30分钟备份一次bin-log,热备份完flush logs。</li>
</ul>
<h3 id="需要备份什么？"><a href="#需要备份什么？" class="headerlink" title="需要备份什么？"></a>需要备份什么？</h3><ul>
<li>二进制文件, InnoDB事务日志</li>
<li>代码，如存储过程</li>
<li>配置</li>
<li>服务器配置</li>
<li>操作系统配置</li>
</ul>
<h3 id="增量备份存在中间增量出错，导致整个备份不可用的风险"><a href="#增量备份存在中间增量出错，导致整个备份不可用的风险" class="headerlink" title="增量备份存在中间增量出错，导致整个备份不可用的风险"></a>增量备份存在中间增量出错，导致整个备份不可用的风险</h3><h3 id="备份中如果要保持数据一致性"><a href="#备份中如果要保持数据一致性" class="headerlink" title="备份中如果要保持数据一致性"></a>备份中如果要保持数据一致性</h3><ul>
<li>使用InnoDB，能够保证一个事务内数据一致备份到另处。但是如果应用逻辑写的不对，导致本应该是一个事务到了两个事务，备份在两个事务之中可能数据不一致。</li>
<li>mysqldump –single-transaction 在InnoBD开始dump开启事务，隔离等级必须是repeatable read. 但是dump时不能执行ALTER TABLE, CREATE TABLE, DROP TABLE, RENAME TABLE, TRUNCATE TABLE。<strong>To dump large tables, combine the –single-transaction option with the –quick option.</strong></li>
</ul>
<h3 id="使用LVM镜像做mysql备份的基本思路"><a href="#使用LVM镜像做mysql备份的基本思路" class="headerlink" title="使用LVM镜像做mysql备份的基本思路"></a>使用LVM镜像做mysql备份的基本思路</h3><ul>
<li>获取读锁</li>
<li>将缓存中的数据写到磁盘</li>
<li>建立快照</li>
<li>释放读锁</li>
</ul>
<h3 id="LVM-CoW原理"><a href="#LVM-CoW原理" class="headerlink" title="LVM CoW原理"></a>LVM CoW原理</h3><ul>
<li>给一个卷打一个快照，只记录元信息，当源卷发生写，把需要改变的那部分数据在未改变前复制到快照。这样，读取快照时，既能保证拍照时的数据一致，又能省时间性能。</li>
<li>LVM快照的一些限制：<ul>
<li>所有文件必须在同一个逻辑卷（分区）</li>
<li>需要有足够空间</li>
</ul>
</li>
</ul>
<h3 id="Mysql的索引"><a href="#Mysql的索引" class="headerlink" title="Mysql的索引"></a>Mysql的索引</h3><ul>
<li>索引在mysql也叫key， mysql有单列索引和多列索引。多列索引根据左序排列。</li>
<li>索引的类型：<ul>
<li>B-Tree索引， MyISAM使用压缩的索引指向数据的物理位置；innodb使用索引指向数据的主键。</li>
</ul>
</li>
<li>一个典型的B+树索引<br>![](.&#x2F;images&#x2F;B+tree.png” width&#x3D;”450” height&#x3D;”450”&gt;</li>
<li>对于下面这个多列索引：索引根据建表时指定key的值，按大小排序<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> people (</span><br><span class="line">last_name <span class="type">VARCHAR</span>(<span class="number">50</span>), <span class="keyword">not</span> <span class="keyword">NULL</span>,</span><br><span class="line">first_name <span class="type">VARCHAR</span> (<span class="number">50</span>), <span class="keyword">not</span> <span class="keyword">NULL</span> ,</span><br><span class="line">dob <span class="type">DATE</span> , <span class="keyword">not</span> <span class="keyword">NULL</span> ,</span><br><span class="line">gender enum(<span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;f&#x27;</span>) <span class="keyword">not</span> <span class="keyword">NULL</span> ,</span><br><span class="line">key(last_name, first_name, dob)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></div>
![](.&#x2F;images&#x2F;multi-col-index.png” width&#x3D;”450” height&#x3D;”450”&gt;</li>
<li>对于多列索引，B+tree适合的查询方式有：<ul>
<li>完全匹配</li>
<li>最左列完全匹配，仅适用于第一个column,即last_name</li>
<li>键值范围, 仅适用于第一个column，即last_name值的范围</li>
<li>键值前缀, 仅适用于第一个column，即last_name begin with</li>
<li>完全匹配一个列，范围匹配另一个列</li>
<li>仅仅查询索引</li>
</ul>
</li>
</ul>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li>Post title：高性能mysql笔记</li>
        <li>Post author：Kopei</li>
        <li>Create time：2017-11-15 00:00:00</li>
        <li>
            Post link：https://kopei.github.io/2017/11/14/database-mysql-2017-11-15-high-performance-mysql/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="../../../../tags/mysql/">#mysql</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="../aliyun-oss/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">Aliyun OSS 小结</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="../../13/Aliyun-oceanDB/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">OceanDB小结</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
                <div class="comment-container">
                    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;Comments
    </div>
    

        
            
 
    <div id="waline"></div>
    <script type="module"  data-pjax>
        import { init } from 'https://evan.beee.top/js/waline.mjs';

        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://kopie-comments-9snhujxxf-kopei.vercel.app',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
            });
        }

        if ('true') {
            const loadWalineTimeout = setTimeout(() => {
                loadWaline();
                clearTimeout(loadWalineTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadWaline);
        }
        
    </script>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">高性能mysql笔记</div>
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#sql%E6%89%A7%E8%A1%8C%E5%A4%A7%E8%87%B4%E6%B5%81%E7%A8%8B"><span class="nav-text">sql执行大致流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql%E7%9A%84%E6%9E%B6%E6%9E%84"><span class="nav-text">mysql的架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AAmysql%E5%AE%9E%E4%BE%8B"><span class="nav-text">启动一个mysql实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql%E7%9A%84%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="nav-text">mysql的并发控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MVCC-Multi-Version-concurrent-control"><span class="nav-text">MVCC(Multi-Version concurrent control)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB"><span class="nav-text">InnoDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E5%8F%AA%E6%9C%89%E5%9C%A8%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%AE%9E%E7%8E%B0"><span class="nav-text">事务只有在存储引擎实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ACID%E6%98%AF%E4%B8%80%E4%B8%AA%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%A0%87%E5%87%86%E7%89%B9%E5%BE%81"><span class="nav-text">ACID是一个事务的标准特征</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%94%E7%A6%BB%E7%AD%89%E7%BA%A7%E4%B8%8B%E7%9A%84%E5%B9%BB%E8%AF%BB%E5%92%8C%E8%84%8F%E8%AF%BB"><span class="nav-text">隔离等级下的幻读和脏读</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%92%8C%E9%9A%94%E7%A6%BB%E7%AD%89%E7%BA%A7%E5%AF%86%E5%88%87%E7%9B%B8%E5%85%B3%E7%9A%84%E5%90%84%E7%A7%8D%E9%94%81-V5-7"><span class="nav-text">和隔离等级密切相关的各种锁(V5.7)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%E5%8F%AF%E4%BB%A5%E6%8F%90%E9%AB%98%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E4%BF%AE%E6%94%B9%E8%A1%A8%E6%95%B0%E6%8D%AE%E6%95%88%E7%8E%87"><span class="nav-text">使用事务日志可以提高存储引擎修改表数据效率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mysql%E6%8F%90%E4%BE%9B%E4%B8%A4%E7%A7%8D%E4%BA%8B%E5%8A%A1%E6%80%A7%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8EInnoDB-NBD-cluster"><span class="nav-text">Mysql提供两种事务性存储引擎InnoDB, NBD cluster</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mysql%E7%9A%84%E5%A4%8D%E5%88%B6%E6%96%B9%E5%BC%8F"><span class="nav-text">Mysql的复制方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1mysql%E5%A4%87%E4%BB%BD%E6%96%B9%E6%A1%88"><span class="nav-text">设计mysql备份方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A8%E8%8D%90%E7%9A%84%E5%A4%87%E4%BB%BD%E6%96%B9%E6%A1%88"><span class="nav-text">推荐的备份方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E8%A6%81%E5%A4%87%E4%BB%BD%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">需要备份什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E9%87%8F%E5%A4%87%E4%BB%BD%E5%AD%98%E5%9C%A8%E4%B8%AD%E9%97%B4%E5%A2%9E%E9%87%8F%E5%87%BA%E9%94%99%EF%BC%8C%E5%AF%BC%E8%87%B4%E6%95%B4%E4%B8%AA%E5%A4%87%E4%BB%BD%E4%B8%8D%E5%8F%AF%E7%94%A8%E7%9A%84%E9%A3%8E%E9%99%A9"><span class="nav-text">增量备份存在中间增量出错，导致整个备份不可用的风险</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%87%E4%BB%BD%E4%B8%AD%E5%A6%82%E6%9E%9C%E8%A6%81%E4%BF%9D%E6%8C%81%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-text">备份中如果要保持数据一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8LVM%E9%95%9C%E5%83%8F%E5%81%9Amysql%E5%A4%87%E4%BB%BD%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%80%9D%E8%B7%AF"><span class="nav-text">使用LVM镜像做mysql备份的基本思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LVM-CoW%E5%8E%9F%E7%90%86"><span class="nav-text">LVM CoW原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mysql%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="nav-text">Mysql的索引</span></a></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>



        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2017</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Kopei</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        VISITOR COUNT&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        TOTAL PAGE VIEWS&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br> 
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v1.2.1</a>
        </div>
        
        
        
            <div id="start_time_div" style="display:none">
                2017/01/01 00:00:00
            </div>
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="unfolded-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="fa-regular fa-arrow-up"></i>
            </li>
        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="folded-tools-list">
        <li class="right-bottom-tools tool-toggle-show flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>



<script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/utils.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/main.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/layouts/menu-shrink.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/tools/go-top-bottom.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/tools/dark-light-toggle.js"></script>


    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/tools/local-search.js"></script>



    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/tools/code-block.js"></script>



    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/layouts/lazyload.js"></script>



    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/tools/runtime.js"></script>
    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/layouts/odometer.min.js"></script>
    <link rel="stylesheet" href="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/assets/odometer-theme-minimal.css">








<div class="post-scripts pjax">
    
        <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/tools/toc-toggle.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/libs/anime.min.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/layouts/toc.js"></script><script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/plugins/tabs.js"></script>
    
</div>


    <script src="//evan.beee.top/projects/hexo-theme-redefine/v1.2.1/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            REDEFINE.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            REDEFINE.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            REDEFINE.refresh();
        });
    });
</script>




</body>
</html>
